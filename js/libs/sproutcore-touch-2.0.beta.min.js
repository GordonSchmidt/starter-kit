// ==========================================================================
// Project:   SproutCore Touch - Touch and Gesture Library For SC 2.0
// Copyright: ©2006-2011 Strobe Inc. and contributors.
//            Portions ©2008-2011 Apple Inc. All rights reserved.
// License:   Licensed under MIT license (see license.js)
// ==========================================================================

(function(a){var b=SC.get,c=SC.set;SC.GestureManager=SC.Object.extend({gestures:null,_redispatchQueue:null,_redispatchToNearestParentViewWaitingForTouches:function(a,c){var d=null,e=!1,c=b(c,"parentView");while(c){var f=b(c,"eventManager");if(f!==undefined&&f!==null){var g=b(f,"gestures");for(var h=0,i=g.length;h<i;h++)b(g[h],"state")===SC.Gesture.WAITING_FOR_TOUCHES&&(d=f);if(d){e=!0,d.touchStart(a,c);break}}c=b(c,"parentView")}return e},touchStart:function(a,b){if(!this._redispatchToNearestParentViewWaitingForTouches(a,b))return this._invokeEvent("touchStart",a,b)},touchMove:function(a,b){return this._invokeEvent("touchMove",a,b)},touchEnd:function(a,b){return this._invokeEvent("touchEnd",a,b)},touchCancel:function(a,b){return this._invokeEvent("touchCancel",a,b)},_invokeEvent:function(a,c,d){var e=b(this,"gestures"),f,g=!0;this._redispatchQueue={};for(var h=0,i=e.length;h<i;h++)f=e[h],handler=f[a],SC.typeOf(handler)==="function"&&(g=handler.call(f,c,d,this));this._flushReDispatchQueue();return g},redispatchEventToView:function(a,b,c){var d=this._redispatchQueue;if(d[b]===undefined)d[b]=[];else{var e=d[b];for(var f=0,g=e.length;f<g;f++)if(a===e[f].view)return}var h=null;c&&c.originalEvent&&(h=c.originalEvent),d[b].push({view:a,originalEvent:h})},_flushReDispatchQueue:function(){var a=this._redispatchQueue;for(var b in a){var c=a[b];for(var d=0,e=c.length;d<e;d++){var f=c[d].view,g=jQuery.Event(b);g.originalEvent=c[d].originalEvent,f.$().trigger(g,this)}}}})})({}),function(a){var b=SC.get,c=SC.set;SC.TouchList=SC.Object.extend({touches:null,timestamp:null,init:function(){this._super(),c(this,"touches",[])},addTouch:function(a){var c=b(this,"touches");c.push(a),this.notifyPropertyChange("touches")},updateTouch:function(a){var c=b(this,"touches");for(var d=0,e=c.length;d<e;d++){var f=c[d];if(f.identifier===a.identifier){c[d]=a,this.notifyPropertyChange("touches");break}}},removeTouch:function(a){var c=b(this,"touches");for(var d=0,e=c.length;d<e;d++){var f=c[d];if(f.identifier===a.identifier){c.splice(d,1),this.notifyPropertyChange("touches");break}}},removeAllTouches:function(){c(this,"touches",[])},touchWithId:function(a){var c=null,d=b(this,"touches");for(var e=0,f=d.length;e<f;e++){var g=d[e];if(g.identifier===a){c=g;break}}return c},length:function(){var a=b(this,"touches");return a.length}.property("touches").cacheable()})}({}),function(a){var b=SC.get,c=SC.set,d=100;SC.Gesture=SC.Object.extend({state:null,name:null,gestureIsDiscrete:!1,touches:null,numberOfActiveTouches:0,numberOfRequiredTouches:1,init:function(){this._super(),this.touches=SC.TouchList.create()},didBecomePossible:function(){},shouldBegin:function(){return!0},didBegin:function(){},didChange:function(){},eventWasRejected:function(){},shouldEnd:function(){return!0},didEnd:function(){},didCancel:function(){},attemptGestureEventDelivery:function(a,b,c){this.notifyViewOfGestureEvent(b,c)===!1?this.eventWasRejected():a.preventDefault()},distance:function(a){if(a.length<2)return 0;var b=a[0],c=a[1],d=b.pageX,e=b.pageY,f=c.pageX,g=c.pageY;return Math.sqrt((d-=f)*d+(e-=g)*e)},centerPointForTouches:function(a){var b=0,c=0;for(var d=0,e=a.length;d<e;d++){var f=a[d];b+=f.pageX,c+=f.pageY}var g={x:b/a.length,y:c/a.length};return g},_objectValues:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},notifyViewOfGestureEvent:function(a,b,c){var d=a[b],e=!0;SC.typeOf(d)==="function"&&(e=d.call(a,this,c));return e},toString:function(){return SC.Gesture+"<"+SC.guidFor(this)+">"},_resetState:function(){this.touches.removeAllTouches()},touchStart:function(a,d,e){var f=a.originalEvent.targetTouches,g=this.touches,h=b(this,"state");c(g,"timestamp",Date.now());for(var i=0,j=f.length;i<j;i++){var k=f[i];g.touchWithId(k.identifier)===null&&g.get("length")<b(this,"numberOfRequiredTouches")&&g.addTouch(k)}g.get("length")<b(this,"numberOfRequiredTouches")?c(this,"state",SC.Gesture.WAITING_FOR_TOUCHES):b(this,"gestureIsDiscrete")&&this.shouldBegin()?(c(this,"state",SC.Gesture.BEGAN),this.didBegin(),this.attemptGestureEventDelivery(a,d,b(this,"name")+"Start")):(c(this,"state",SC.Gesture.POSSIBLE),this.didBecomePossible()),e.redispatchEventToView(d,"touchstart",a)},touchMove:function(a,d,e){var f=b(this,"state");if(f===SC.Gesture.WAITING_FOR_TOUCHES||f===SC.Gesture.ENDED||f===SC.Gesture.CANCELLED)e.redispatchEventToView(d,"touchmove",a);else{var g=a.originalEvent.changedTouches,h=this.touches;c(h,"timestamp",Date.now());for(var i=0,j=g.length;i<j;i++){var k=g[i];h.updateTouch(k)}f===SC.Gesture.POSSIBLE?this.shouldBegin()&&(c(this,"state",SC.Gesture.BEGAN),this.didBegin(),this.didChange(),this.attemptGestureEventDelivery(a,d,b(this,"name")+"Start")):f!==SC.Gesture.BEGAN&&f!==SC.Gesture.CHANGED||!!b(this,"gestureIsDiscrete")?e.redispatchEventToView(d,"touchmove",a):(c(this,"state",SC.Gesture.CHANGED),this.didChange(),this.attemptGestureEventDelivery(a,d,b(this,"name")+"Change"))}},touchEnd:function(a,d,e){b(this,"gestureIsDiscrete")?this.state===SC.Gesture.BEGAN&&this.shouldEnd()?(c(this,"state",SC.Gesture.ENDED),this.didEnd(),this.attemptGestureEventDelivery(a,d,b(this,"name")+"End")):(c(this,"state",SC.Gesture.CANCELLED),this.didCancel(),this.attemptGestureEventDelivery(a,d,b(this,"name")+"Cancel")):(this.state!==SC.Gesture.ENDED&&this.shouldEnd()&&(c(this,"state",SC.Gesture.ENDED),this.didEnd(),this.attemptGestureEventDelivery(a,d,b(this,"name")+"End")),e.redispatchEventToView(d,"touchend",a)),this._resetState()},touchCancel:function(a,d,e){this.state!==SC.Gesture.CANCELLED?(this._resetState(),c(this,"state",SC.Gesture.CANCELLED),this.notifyViewOfGestureEvent(d,b(this,"name")+"Cancel")):e.redispatchEventToView(d,"touchcancel",a)}}),SC.Gesture.WAITING_FOR_TOUCHES=0,SC.Gesture.POSSIBLE=1,SC.Gesture.BEGAN=2,SC.Gesture.CHANGED=3,SC.Gesture.ENDED=4,SC.Gesture.CANCELLED=4}({}),function(a){var b=SC.get,c=SC.set,d=100;SC.PinchGestureRecognizer=SC.Gesture.extend({scale:1,numberOfRequiredTouches:2,_startingDistanceBetweenTouches:null,_previousTimestamp:null,_previousDistance:0,_deltaThreshold:5,_previousScale:1,didBecomePossible:function(){this._startingDistanceBetweenTouches=this.distance(b(this.touches,"touches")),this._previousDistance=this._startingDistanceBetweenTouches,this._previousTimestamp=b(this.touches,"timestamp")},shouldBegin:function(){var a=this.distance(b(this.touches,"touches"));return Math.abs(a-this._startingDistanceBetweenTouches)>=this._deltaThreshold},didChange:function(){var a=this._previousScale=b(this,"scale"),d=this.touches.timestamp-this._previousTimestamp,e=this.distance(b(this.touches,"touches")),f=e-this._previousDistance;c(this,"velocity",f/d),c(this,"scale",e/this._previousDistance),this._previousTimestamp=b(this.touches,"timestamp"),this._previousDistance=e},eventWasRejected:function(){c(this,"scale",this._previousScale)}}),SC.Gestures.register("pinch",SC.PinchGestureRecognizer)}({}),function(a){var b=SC.get,c=SC.set,d=0;SC.PanGestureRecognizer=SC.Gesture.extend({translation:null,_previousLocation:null,_previousTranslation:null,_translationThreshold:5,init:function(){this._super(),c(this,"translation",{x:0,y:0})},didBecomePossible:function(){this._previousLocation=this.centerPointForTouches(b(this.touches,"touches"))},shouldBegin:function(){var a=this._previousLocation,c=this.centerPointForTouches(b(this.touches,"touches")),d=a.x,e=a.y,f=c.x,g=c.y,h=Math.sqrt((d-=f)*d+(e-=g)*e);return h>=this._translationThreshold},didChange:function(){var a=this._previousLocation,d=this.centerPointForTouches(b(this.touches,"touches")),e={x:d.x,y:d.y};e.x=d.x-a.x,e.y=d.y-a.y,this._previousTranslation=b(this,"translation"),c(this,"translation",e),this._previousLocation=d},eventWasRejected:function(){c(this,"translation",this._previousTranslation)}}),SC.Gestures.register("pan",SC.PanGestureRecognizer)}({}),function(a){var b=SC.get,c=SC.set;SC.TapGestureRecognizer=SC.Gesture.extend({numberOfTaps:1,MULTITAP_DELAY:150,gestureIsDiscrete:!0,_initialLocation:null,_waitingInterval:null,_waitingForMoreTouches:!1,_moveThreshold:10,shouldBegin:function(){return b(this.touches,"length")===b(this,"numberOfRequiredTouches")},didBegin:function(){this._initialLocation=this.centerPointForTouches(b(this.touches,"touches")),b(this.touches,"length")<b(this,"numberOfTaps")&&(this._waitingForMoreTouches=!0,this._waitingInterval=window.setInterval(this._intervalFired,this.MULTITAP_DELAY))},shouldEnd:function(){var a=this.centerPointForTouches(b(this.touches,"touches")),c=this._initialLocation.x,d=this._initialLocation.y,e=a.x,f=a.y,g=Math.sqrt((c-=e)*c+(d-=f)*d);return Math.abs(g)<this._moveThreshold&&!this._waitingForMoreTouches},didEnd:function(){this._initialLocation=null},didCancel:function(){this._initialLocation=null},_intervalFired:function(){window.clearInterval(this._waitingInterval),_waitingForMoreTouches=!1}}),SC.Gestures.register("tap",SC.TapGestureRecognizer)}({}),function(a){}({}),function(a){var b=SC.get,c=SC.set;SC.View.reopen({eventManager:null,init:function(){this._super();var a=SC.Gestures.knownGestures(),d=b(this,"eventManager");if(a&&!d){var e=[];for(var f in a)if(this[f+"Start"]||this[f+"Change"]||this[f+"End"]){var g;this[f+"Options"]!==undefined&&typeof this[f+"Options"]=="object"?g=this[f+"Options"]:g={},g.name=f,g.view=this,e.push(a[f].create(g))}var h=SC.GestureManager.create({gestures:e});c(this,"eventManager",h)}}})}({}),function(a){var b=SC.get,c=SC.set;SC.Gestures=SC.Object.create({_registeredGestures:null,init:function(){this._registeredGestures={};return this._super()},register:function(a,b){var c=this._registeredGestures;if(c[a]!==undefined)throw new SC.Error(a+" already exists as a registered gesture recognizers. Gesture recognizers must have globally unique names.");c[a]=b},unregister:function(a){var b=this._registeredGestures;b[a]!==undefined&&(b[a]=undefined)},knownGestures:function(){var a=this._registeredGestures;return a?a:{}}})}({}),function(a){}({}),function(a){var b={cursors:[],_data:{},_touchstart:function(a){this._create_event("touchstart",a,{})},_touchmove:function(a){this._create_event("touchmove",a,{})},_touchend:function(a){this._create_event("touchend",a,{})},_create_event:function(a,b,c){var d=document.createEvent("CustomEvent");d.initEvent(a,!0,!0),d.touches=this.cursors,d.targetTouches=this._get_target_touches(b.target),d.changedTouches=[b];for(var e in c)c.hasOwnProperty(e)&&(d[e]=c[e]);b.target?b.target.dispatchEvent(d):document.dispatchEvent(d)},_get_target_touches:function(a){var b=[];for(var c=0;c<this.cursors.length;c++){var d=this.cursors[c];d.target==a&&b.push(d)}return b},callback:function(a,b,c,d,e,f){var g;a!==3?g=this._data[b]:(g={sid:b,fid:c},this._data[b]=g),g.identifier=b,g.pageX=window.innerWidth*d,g.pageY=window.innerHeight*e,g.target=document.elementFromPoint(g.pageX,g.pageY);switch(a){case 3:this.cursors.push(g),this._touchstart(g);break;case 4:this._touchmove(g);break;case 5:this.cursors.splice(this.cursors.indexOf(g),1),this._touchend(g);break;default:}a===5&&delete this._data[b]}};window.tuio_callback=function(a,c,d,e,f,g){b.callback(a,c,d,e,f,g)}}({}),function(a){}({})
